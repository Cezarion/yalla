#!/usr/bin/env bash

#
#
# @authors Mathias Gorenflot (mathias.gorenflot@fabernovel.com)
# @date    2017-08-30 21:22:02
# @version $Id$
# @package yalla
#

###############################################################################
# Bash 'Strict Mode'
# http://redsymbol.net/articles/unofficial-bash-strict-mode
# https://github.com/alphabetum/bash-boilerplate#bash-strict-mode
set -o nounset
set -o errexit
set -o pipefail
IFS=$'\n\t'
trap 'echo "Aborting due to errexit on line $LINENO. Exit code: $?" >&2' ERR


###############################################################################
##
## Set paths
##

# Path variable
# From /usr/local/bin/yalla

set -o allexport
APP_PATH=$WORKING_DIR

# Set paths
APP_YALLA_PATH="${WORKING_DIR}/yalla"
APP_YALLA_SRC="${APP_YALLA_PATH}/src"
APP_YALLA_LIB="${APP_YALLA_PATH}/src/lib"
APP_YALLA_ACTIONS="${APP_YALLA_PATH}/src/actions"
APP_YALLA_PLUGINS="${APP_YALLA_PATH}/src/plugins"


###############################################################################
##
## This file dispatch yalla command
##

. "${APP_YALLA_LIB}/common.sh"

set +o allexport


# Die if it's not a yalla project

# Script to run
ACTION=$1

#
# To preserve the original arguments,
# the _arg_list function converts the array to a string.
# Now you convert the string to a table
#
#
IFS=$'\n'; ARGS=($(echo $2 | egrep -o '"[^"]*"|\S+'))


# List args
# for arg in "${ARGS[@]}"
#     do
#         printf "${arg}\n"
# done

case "$ACTION" in
    docker | dr)
        sh "${APP_YALLA_ACTIONS}/devilbox" "${ARGS[@]}"
    ;;
    db | mysql)
        sh "${APP_YALLA_ACTIONS}/devilbox" mysql "${ARGS[@]}"
    ;;
esac