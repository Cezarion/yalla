#!/usr/bin/env bash

# Exit immediately on error
set -e
trap 'echo "Aborting due to errexit on line $LINENO. file $(cd $(dirname "$0"); pwd)/$(basename "$0"). Exit code: $?" >&2' ERR

readonly DV_ACTION=$1
shift

case "$DV_ACTION" in
    config | stop | build )
        $docker_cmd "$DV_ACTION"
        ;;
    up | start)
        $docker_cmd up -d $DOCKER_STACK
        ;;
    restart)
        $docker_cmd stop && $docker_cmd rm -f && $docker_cmd up -d $DOCKER_STACK
        ;;
    cleanup)
        $docker_cmd rm -f
        ;;
    ssh)
        $docker_exec "cd ${CWD}; exec bash -l"
        ;;
    connect)
        $docker_exec "cd ${CWD}/${CURRENT_DIR_NAME}; exec bash -l"
        ;;
    exec)
        #shift
        $docker_exec "cd ${CWD}/${CURRENT_DIR_NAME}; $(_args_list "$@")"
        ;;
    # ------ unsed
    # code)
    #     shift
    #     $docker_exec "cd ${CWD}/${CURRENT_DIR_NAME}/; ./code $(_args_list "$@")"
    #     ;;
    # There is a bug with docker compose and pipe, tty, ..
    # so I use a script to execute a script on the docker container
    # @see https://github.com/docker/compose/issues/3352
    # ------ / unsed
    # ----- Really necessary ?
    # install)
    #     _info "Start docker stack"
    #     $docker_cmd up -d $DOCKER_STACK;

    #     _info "\nCreate database or import an existing file"
    #     _mysql_install_actions


    #     _info "Install project"
    #     $docker_exec "cd ${CWD}/${CURRENT_DIR_NAME}/; ./code install";
    #     ;;
    # ------ / really
    shortlist | -h | --help )
            echo '
      config            Validate and view the Compose file
      stop              Stop services
      start | up        Start services
      build             Build or rebuild services
      cleanup           Remove stopped containers
      ssh               Connect to main docker container, where the code is and where the commands are available (wp cli, node, ...)
      connect           Connect to main docker container, directly in path to project
      exec              Execute a command in a running container
      restart           Stop and restart container with cleanup
        '
        ;;
    *)
        yalla -h
        _br
        _error "${DV_ACTION} is not a registered command"
        exit 1
esac
